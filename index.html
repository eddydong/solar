<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black">  
</head>

<body id="body" style="overflow: hidden; margin: 0; background: #000000">
<div id="DivMain" sytle="width:100%; height:100%; position:absolute;">
<canvas id="DivCanvas" sytle="width:100%; height:100%; position:absolute;"></canvas>
</div>
</body>

<script>

var
	requestAnimationFrame = window.requestAnimationFrame 
		|| window.mozRequestAnimationFrame 
		|| window.webkitRequestAnimationFrame 
		|| window.msRequestAnimationFrame,

	cancelAnimationFrame = window.cancelAnimationFrame 
		|| window.mozCancelAnimationFrame 
		|| window.webkitCancelRequestAnimationFrame,

	ImgEarth = new Image(), ImgMoon = new Image(), ImgShip = new Image(),
	ImgSun = new Image(), ImgMercury = new Image(), ImgVenus = new Image(),
	ImgMars = new Image(), ImgJupiter = new Image(), ImgSaturn = new Image(),
	ImgUranus = new Image(), ImgNeptune = new Image(),

	canvas=document.getElementById("DivCanvas"),
	ctx=canvas.getContext("2d"),
	
	AU=149597870700,
	shortedge, earth, me, zoom=1/3, tzoom=1, thistick=0, lasttick=0, 
	interval=17, universe=[], currentball=0, starttime=0, newlinepos=0,
	drawcircle=false;


function loadimages(){
	ImgEarth.src = "img/earth.png";
	ImgMoon.src="img/moon.png";
	ImgShip.src="img/ship.png";
	ImgSun.src="img/sun.png";
	ImgMercury.src="img/mercury.png";
	ImgVenus.src="img/venus.png";
	ImgMars.src="img/mars.png";
	ImgJupiter.src="img/jupiter.png";
	ImgSaturn.src="img/saturn.png";
	ImgUranus.src="img/uranus.png";
	ImgNeptune.src="img/neptune.png";
};

function buildobjs(){
	//name,img,imgScale, imgOffsetX, imgOffsetY, x,y,r,m,v,dv
	earth= new Ball('Earth', ImgEarth, 1.02, 0,0, -1.5e11, 0, 6.375e6, 5.965e24, 29.79e3, Math.PI/2);
	moon=new Ball('Moon', ImgMoon, 1, 0,0,  -384000e3-1.5e11,0, 1738.14e3, 7.349e22, 1020+29.79e3, Math.PI/2);
	sun = new Ball('Sun', ImgSun, 1.17,  0,0, 0,0, 696300e3, 1.989e30, 0, 0);
	mercury = new Ball('Mercury', ImgMercury, 1, 0,0,  -5791e7,0, 2440e3, 5.965e24*0.0553, 47.89e3, Math.PI/2);
	venus = new Ball('Venus', ImgVenus, 1, 0,0,  -108208930e3,0, 6052e3, 5.965e24*0.815, 35.03e3, -Math.PI/2);
	mars = new Ball('Mars', ImgMars, 1, 0,0,  -227940000e3,0, 3398e3, 5.965e24*0.1074, 24.13e3, Math.PI/2);
	jupiter = new Ball('Jupiter', ImgJupiter, 1, 0,0,  -778330000e3,0, 71492e3, 1.9e27, 13.06e3, Math.PI/2);
	saturn = new Ball('Saturn', ImgSaturn, 3, -0.012,0.016,  -1429400000e3,0, 60330e3, 5.965e24*95.18, 9.65e3, Math.PI/2);
	uranus = new Ball('Uranus', ImgUranus, 1, 0,0,  -19.2184*AU,0, 25559e3, 5.965e24*14.54, 6.81e3, Math.PI/2);
	neptune = new Ball('Neptune', ImgNeptune, 1, 0,0,  -30.1104*AU,0, 24764e3, 5.965e24*17.15, 5.43e3, Math.PI/2);

	me = new Ball('Ship', ImgShip, 1, 0,0, -(6.375e6+1e2+550e3)-1.5e11, 0, 1e2, 100e3, 9000+29.79e3, Math.PI/2+0.01);

	universe.push(me);
	universe.push(earth);
	universe.push(moon);

	universe.push(sun);
	universe.push(mercury);
	universe.push(venus);
	universe.push(mars);
	universe.push(jupiter);
	universe.push(saturn);
	universe.push(uranus);
	universe.push(neptune);
};

function getangle(dx, dy){
dx=dx || 0;
dy=dy || 0;
var a=Math.atan(dy/dx);
if (dx<0 && dy>0) { a+=Math.PI; };
if (dx<0 && dy<0) { a+=Math.PI; };
if (dx>0 && dy<0) { a+=2*Math.PI; };
if (dx<0 && dy==0) { a=Math.PI;};
if (dx==0 && dy==0) { a=0;};
return a%(Math.PI*2);
};

function Ball(name,img,imgScale, imgOffsetX, imgOffsetY, x,y,r,m,v,dv){
	this.img=img;
	this.imgScale=imgScale;
	this.imgOffsetX=imgOffsetX;
	this.imgOffsetY=imgOffsetY;
	this.r=r;
	this.m=m;
	this.x=x;
	this.y=y;
	this.v=v;
	this.dv=dv;
	this.a=0;
	this.da=0;
	this.tail=[];
	this.live=true;
	this.name=name;
};
Ball.prototype={
	draw: function() {
		for (i in this.tail){
			ctx.save();
			ctx.fillStyle='rgba(100,100,100,'+i/this.tail.length+')';
			ctx.translate(canvas.width/2-universe[currentball].x*zoom+this.tail[i][0]*zoom,
				canvas.height/2-universe[currentball].y*zoom+this.tail[i][1]*zoom);
			ctx.fillRect(-1,-1,2,2);
			ctx.restore();
		};

		ctx.save();
		ctx.translate(canvas.width/2-universe[currentball].x*zoom+this.x*zoom, 
				canvas.height/2-universe[currentball].y*zoom+this.y*zoom);
		ctx.rotate(this.d);
		var longside, imgH, imgW;
		if (this.img.width>this.img.height) {
			imgW=this.imgScale*this.r*zoom*2,
			imgH=imgW*this.img.height/this.img.width;
			longside=imgW;
		} else {
			imgH=this.imgScale*this.r*zoom*2,
			imgW=imgH*this.img.width/this.img.height;
			longside=imgH;
		};		
		ctx.drawImage(this.img, -imgW/2+imgW*this.imgOffsetX, -imgH/2+imgH*this.imgOffsetY, imgW, imgH);
		
		if (drawcircle){
		ctx.strokeStyle="red";
		ctx.beginPath();
		ctx.arc(0,0,this.r*zoom,0,2*Math.PI);
		ctx.stroke();
		};

		ctx.restore();
	},
	update: function(){
		this.d=this.dv+Math.PI/2;
		this.ax=0;
		this.ay=0;
		for (var i in universe){
			if (universe[i]!=this){
				this.a=gravity(this, universe[i])/this.m;
				this.da=getangle(universe[i].x-this.x, universe[i].y-this.y);
				this.ax+=this.a*Math.cos(this.da);
				this.ay+=this.a*Math.sin(this.da);	
							
				if (distance(this, universe[i])<=this.r+universe[i].r) {
					this.live=false;
					if (this.m>universe[i].m) {
						//universe.splice[i];			
					} else {
						//universe.splice[i];
					};
				};
			};
		};
				
		if (this.live) {
		
		this.vx=this.v*Math.cos(this.dv);
		this.vy=this.v*Math.sin(this.dv);
		
		this.x+=tzoom*interval/1000*this.vx;
		this.y+=tzoom*interval/1000*this.vy;

		this.vx+=tzoom*interval/1000*this.ax;
		this.vy+=tzoom*interval/1000*this.ay;
			
 	 	this.v=Math.pow((Math.pow(this.vx,2)+Math.pow(this.vy,2)),1/2);
 		this.dv=getangle(this.vx, this.vy);
		}

		var point=[this.x, this.y];
		this.tail.push(point);
	 	if (this.tail.length>2000){this.tail.splice(1,1);};	 	
	}
};

function gravity(a,b){
	return (a.m*b.m*6.67259e-11)/(Math.pow(a.x-b.x,2)+Math.pow(a.y-b.y,2));
};

function distance(a,b){
	return Math.pow(Math.pow(a.x-b.x,2)+Math.pow(a.y-b.y,2), 1/2);
};

function resize(){
	canvas.width=window.innerWidth;
	canvas.height=window.innerHeight;
};

Date.prototype.format = function(fmt) 
{ //author: meizz 
  var o = { 
    "M+" : this.getMonth()+1,                 //月份 
    "d+" : this.getDate(),                    //日 
    "h+" : this.getHours(),                   //小时 
    "m+" : this.getMinutes(),                 //分 
    "s+" : this.getSeconds(),                 //秒 
    "q+" : Math.floor((this.getMonth()+3)/3), //季度 
    "S"  : this.getMilliseconds()             //毫秒 
  }; 
  if(/(y+)/.test(fmt)) 
    fmt=fmt.replace(RegExp.$1, ((this.getFullYear())+"").substr(4 - RegExp.$1.length)); 
  for(var k in o) 
    if(new RegExp("("+ k +")").test(fmt)) 
  fmt = fmt.replace(RegExp.$1, (RegExp.$1.length==1) ? (o[k]) : (("00"+ o[k]).substr((""+ o[k]).length))); 
  return fmt; 
};

function printline(s){
	newlinepos+=20;
	ctx.save();
	ctx.font="16px Arial";
	ctx.fillStyle="#bbbbbb";
	ctx.fillText(s,0,newlinepos);
	ctx.restore();
};

function showstatus(){
	var t= new Date((lasttick-starttime)*tzoom);
	printline("Launched At 1970-01-01 08:00:00");
	printline("Current Time= "+t.format("yyyy-MM-dd hh:mm:ss"));
	printline("1 Second= "+tzoom/60+" Mintues (Q: Faster | W: Slower)");
	printline("(A: Zoom In | Z: Zoom Out)");
	printline("");
	printline("Current Object= "+universe[currentball].name+" (Space: Switch Current Object)");
	printline("Mass= "+universe[currentball].m);
	printline("Radius= "+universe[currentball].r);
	printline("Center X= "+universe[currentball].x);
	printline("Center Y= "+universe[currentball].y);
	printline("Acceleration= "+universe[currentball].a);
	printline("Acceleration Angle= "+universe[currentball].da);
	printline("Velocity= "+universe[currentball].v);
	printline("Velocity Angle= "+universe[currentball].dv);
	printline("Tail Length= "+universe[currentball].tail.length);
	printline("");
	printline("FPS= "+Math.round(1000/interval));
};

function anim(){
	thistick=new Date();
	if (thistick-lasttick<40) {interval=thistick-lasttick;};
	lasttick=thistick;

	ctx.fillStyle='#000000';
	ctx.fillRect(0,0,canvas.width, canvas.height);
	
	for (var i in universe){
		universe[i].update();
		universe[i].draw();
	};
	
	newlinepos=0;
	showstatus();

	animId=requestAnimationFrame(anim);
};

document.onkeydown = function(){
    var oEvent = window.event;
    if (oEvent.keyCode ==65) {zoom=zoom*1.2};
    if (oEvent.keyCode ==90) {zoom=zoom/1.2};   
    if (oEvent.keyCode ==81) {tzoom=tzoom*1.2};
    if (oEvent.keyCode ==87) {tzoom=tzoom/1.2};   
    if (oEvent.keyCode ==32) {
    	currentball++; 
    	if (currentball==universe.length){currentball=0};
    };
    if (oEvent.keyCode ==38) {if (universe[0].v*1.1<=300000e3) {universe[0].v*=1.1;}};
    if (oEvent.keyCode ==40) {if (universe[0].v/1.1>=0) {universe[0].v/=1.1;}};
    if (oEvent.keyCode ==39) {universe[0].dv+=0.05;};
    if (oEvent.keyCode ==37) {universe[0].dv-=0.05;};
    if (oEvent.keyCode ==67) {drawcircle=!drawcircle;};
};

resize();
starttime=new Date();
loadimages();
buildobjs();
ImgEarth.onload=resize;
window.addEventListener("resize", resize);
anim();

</script>
